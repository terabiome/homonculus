---
# ServiceAccount for Temporal Workers
apiVersion: v1
kind: ServiceAccount
metadata:
  name: temporal-worker
  namespace: temporal

---
# Role for Temporal Workers (access to pods, configmaps)
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: temporal-worker
  namespace: temporal
rules:
- apiGroups: [""]
  resources:
  - pods
  - configmaps
  - secrets
  verbs: ["get", "list", "watch"]

---
# RoleBinding for Temporal Workers
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: temporal-worker
  namespace: temporal
subjects:
- kind: ServiceAccount
  name: temporal-worker
  namespace: temporal
roleRef:
  kind: Role
  name: temporal-worker
  apiGroup: rbac.authorization.k8s.io

---
# Temporal Worker DaemonSet (runs on all worker nodes)
# Co-located with workloads for local filesystem access
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: temporal-worker
  namespace: temporal
  labels:
    app: temporal-worker
    component: worker
spec:
  selector:
    matchLabels:
      app: temporal-worker
  template:
    metadata:
      labels:
        app: temporal-worker
        component: worker
    spec:
      serviceAccountName: temporal-worker
      
      # Run on worker nodes only (not master)
      nodeSelector:
        role: worker
      
      containers:
      - name: temporal-worker
        image: your-registry/temporal-worker:latest  # Replace with your worker image
        imagePullPolicy: IfNotPresent
        
        env:
        - name: TEMPORAL_ADDRESS
          value: "temporal.temporal.svc.cluster.local:7233"
        - name: TEMPORAL_NAMESPACE
          value: "default"
        - name: TEMPORAL_TASK_QUEUE
          value: "finance-analysis"
        - name: MINIO_ENDPOINT
          value: "minio.storage.svc.cluster.local:9000"
        - name: MINIO_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: access-key
        - name: MINIO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: secret-key
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        
        # CRITICAL: Resource guarantees prevent CPU starvation
        # Temporal worker MUST get CPU even during heavy SLM inference
        resources:
          requests:
            memory: "4Gi"        # Guaranteed 4GB
            cpu: "2000m"         # Guaranteed 2 cores (CRITICAL!)
          limits:
            memory: "8Gi"        # Can use up to 8GB
            cpu: "2000m"         # No burst (strict reservation)
        
        volumeMounts:
        # Mount local staging directory (shared with SLM pods)
        - name: local-staging
          mountPath: /data/local
        
        livenessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - pgrep -f temporal-worker
          initialDelaySeconds: 30
          periodSeconds: 30
        
        readinessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - pgrep -f temporal-worker
          initialDelaySeconds: 10
          periodSeconds: 10
      
      volumes:
      # Local staging volume (hostPath on worker VMs)
      - name: local-staging
        hostPath:
          path: /data/local
          type: DirectoryOrCreate

---
# Secret for MinIO credentials (create this manually or via sealed-secrets)
apiVersion: v1
kind: Secret
metadata:
  name: minio-credentials
  namespace: temporal
type: Opaque
stringData:
  access-key: "admin"
  secret-key: "locness-lake-password"  # CHANGE THIS!


